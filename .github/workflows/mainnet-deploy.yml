name: Deploy to Mainnet

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run Tests
      run: |
        npm test
        cd sultan-mainnet && go test ./...
        cargo test --all

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Build Docker Image
      run: |
        docker build -t sultan-chain:${{ github.sha }} ./sultan-mainnet
        docker tag sultan-chain:${{ github.sha }} sultan-chain:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f sultan-mainnet/deployments/
        kubectl set image deployment/sultan-mainnet sultan=sultan-chain:${{ github.sha }}
