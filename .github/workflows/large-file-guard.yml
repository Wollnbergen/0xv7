// filepath: /workspaces/0xv7/.github/workflows/large-file-guard.yml
name: Large file guard
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Fetch base branch
        run: |
          git fetch --no-tags --prune --depth=1 origin "${{ github.event.pull_request.base.ref }}"
      - name: Block files >50MB in the PR
        run: |
          set -euo pipefail
          base_ref="origin/${{ github.event.pull_request.base.ref }}"
          changed="$(git diff --name-only --diff-filter=AMRC "$base_ref"...HEAD)"
          [ -z "$changed" ] && { echo "No tracked changes."; exit 0; }
          big=""
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            sz=$(wc -c <"$f")
            [ "$sz" -ge $((50*1024*1024)) ] && big+="$f ($sz bytes)\n"
          done <<< "$changed"
          if [ -n "$big" ]; then
            printf "The following files exceed 50MB:\n%b" "$big"
            exit 1
          fi
