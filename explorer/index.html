<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  SULTAN BLOCK EXPLORER                                                    ‚ïë
  ‚ïë                                                                           ‚ïë
  ‚ïë  Block explorer UI for viewing Sultan blockchain data.                    ‚ïë
  ‚ïë  Connects to RPC at rpc.sltn.io (production) or localhost:26657 (dev)     ‚ïë
  ‚ïë                                                                           ‚ïë
  ‚ïë  ‚ö†Ô∏è  DO NOT CONFUSE WITH:                                                 ‚ïë
  ‚ïë      - /wallet-extension/index.html (PWA wallet - wallet.sltn.io)         ‚ïë
  ‚ïë      - /replit-website/index.html (marketing website - sltn.io)           ‚ïë
  ‚ïë                                                                           ‚ïë
  ‚ïë  Location: /explorer/index.html                                           ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://rpc.sltn.io http://localhost:26657; frame-src 'none'; frame-ancestors 'none'; form-action 'self'; base-uri 'self'; object-src 'none'" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Sultan Blockchain Explorer - View blocks, transactions, validators, and network statistics for the Sultan L1 zero-gas blockchain" />
    <title>Sultan Block Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --accent: #10b981;
            --bg-dark: #0f0f23;
            --bg-card: #1a1a2e;
            --bg-card-hover: #252542;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #64748b;
            --border: #2d2d44;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .logo-text span {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .network-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
        }
        
        .network-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        .network-dot.offline {
            background: var(--error);
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Search */
        .search-container {
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .search-input {
            flex: 1;
            padding: 16px 20px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1em;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-input:focus {
            outline: none;
        }
        
        .search-btn {
            padding: 16px 24px;
            background: var(--primary);
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.75em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-value.zero-gas {
            background: linear-gradient(90deg, var(--accent), #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 0.875em;
            color: var(--success);
        }
        
        /* Tables */
        .section {
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 1.25em;
            font-weight: 600;
        }
        
        .view-all {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.875em;
            font-weight: 500;
        }
        
        .view-all:hover {
            text-decoration: underline;
        }
        
        .table-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 16px 20px;
            background: rgba(139, 92, 246, 0.1);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
        }
        
        .data-table tr:hover td {
            background: var(--bg-card-hover);
        }
        
        .hash-link {
            color: var(--primary);
            text-decoration: none;
        }
        
        .hash-link:hover {
            text-decoration: underline;
        }
        
        .address {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .badge-info {
            background: rgba(139, 92, 246, 0.15);
            color: var(--primary);
        }
        
        /* Validators */
        .validator-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .validator-rank {
            width: 28px;
            height: 28px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .validator-info {
            flex: 1;
        }
        
        .validator-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .validator-address {
            font-size: 0.75em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: 12px;
            padding: 16px 20px;
            color: var(--error);
            margin-bottom: 20px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            color: var(--text-muted);
            font-size: 0.875em;
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }
        
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-table {
                font-size: 0.8em;
            }
            
            .data-table th, .data-table td {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üëë</div>
                <div class="logo-text">Sultan <span>Explorer</span></div>
            </div>
            <div class="network-badge">
                <div class="network-dot" id="networkDot"></div>
                <span id="networkStatus">Connecting...</span>
            </div>
        </header>
        
        <!-- Search -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search by address, tx hash, or block height..." />
                <button class="search-btn" onclick="handleSearch()">Search</button>
            </div>
        </div>
        
        <!-- Error Display -->
        <div id="errorContainer"></div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Block Height</div>
                <div class="stat-value" id="blockHeight">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Gas Fees</div>
                <div class="stat-value zero-gas">0 SLTN</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Validators</div>
                <div class="stat-value" id="validatorCount">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Staked</div>
                <div class="stat-value" id="totalStaked">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Staking APY</div>
                <div class="stat-value" id="stakingApy">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Supply</div>
                <div class="stat-value" id="totalSupply">--</div>
            </div>
        </div>
        
        <!-- Recent Blocks -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">üì¶ Recent Blocks</h2>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Height</th>
                            <th>Hash</th>
                            <th>Txns</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="blocksTable">
                        <tr>
                            <td colspan="4" class="loading">
                                <div class="spinner"></div>
                                Loading blocks...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Validators -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">üõ°Ô∏è Validators</h2>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Validator</th>
                            <th>Stake</th>
                            <th>Commission</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="validatorsTable">
                        <tr>
                            <td colspan="4" class="loading">
                                <div class="spinner"></div>
                                Loading validators...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer">
            <p>Sultan L1 ‚Ä¢ Zero Gas Fees ‚Ä¢ Native Rust Blockchain</p>
            <p style="margin-top: 8px;">
                <a href="https://sltn.io" target="_blank">Website</a> ‚Ä¢ 
                <a href="https://wallet.sltn.io" target="_blank">Wallet</a> ‚Ä¢ 
                <a href="https://github.com/Wollnbergen/0xv7" target="_blank">GitHub</a>
            </p>
        </footer>
    </div>
    
    <script>
        // Configuration
        const RPC_ENDPOINTS = [
            'https://rpc.sltn.io',
            'http://localhost:26657'
        ];
        let activeRpc = null;
        let isConnected = false;
        
        // Helper functions
        function formatNumber(num) {
            if (num === null || num === undefined) return '--';
            return new Intl.NumberFormat().format(num);
        }
        
        function formatSltn(amount, decimals = 9) {
            if (!amount) return '0';
            const value = Number(amount) / Math.pow(10, decimals);
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            if (value >= 1e3) return (value / 1e3).toFixed(2) + 'K';
            return value.toFixed(2);
        }
        
        function shortenHash(hash, chars = 8) {
            if (!hash || hash.length < chars * 2) return hash || '--';
            return hash.slice(0, chars) + '...' + hash.slice(-chars);
        }
        
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">‚ö†Ô∏è ${message}</div>`;
            setTimeout(() => container.innerHTML = '', 10000);
        }
        
        function updateNetworkStatus(connected) {
            const dot = document.getElementById('networkDot');
            const status = document.getElementById('networkStatus');
            
            if (connected) {
                dot.classList.remove('offline');
                status.textContent = 'Connected';
            } else {
                dot.classList.add('offline');
                status.textContent = 'Offline';
            }
        }
        
        // RPC Calls
        async function tryEndpoints() {
            for (const endpoint of RPC_ENDPOINTS) {
                try {
                    const response = await fetch(`${endpoint}/status`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: AbortSignal.timeout(5000)
                    });
                    if (response.ok) {
                        activeRpc = endpoint;
                        isConnected = true;
                        updateNetworkStatus(true);
                        console.log('Connected to:', endpoint);
                        return true;
                    }
                } catch (e) {
                    console.log('Failed to connect to:', endpoint);
                }
            }
            isConnected = false;
            updateNetworkStatus(false);
            return false;
        }
        
        async function fetchRpc(path) {
            if (!activeRpc) {
                await tryEndpoints();
            }
            if (!activeRpc) {
                throw new Error('No RPC endpoint available');
            }
            
            const response = await fetch(`${activeRpc}${path}`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                signal: AbortSignal.timeout(10000)
            });
            
            if (!response.ok) {
                throw new Error(`RPC error: ${response.status}`);
            }
            
            return response.json();
        }
        
        // Data Loading
        async function loadStatus() {
            try {
                const data = await fetchRpc('/status');
                document.getElementById('blockHeight').textContent = formatNumber(data.height || data.block_height);
            } catch (e) {
                console.error('Failed to load status:', e);
            }
        }
        
        async function loadValidators() {
            try {
                const data = await fetchRpc('/staking/validators');
                const validators = data.validators || data || [];
                
                document.getElementById('validatorCount').textContent = validators.length;
                
                const tbody = document.getElementById('validatorsTable');
                if (validators.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No validators found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = validators.slice(0, 10).map((v, i) => `
                    <tr>
                        <td>
                            <div class="validator-row">
                                <div class="validator-rank">${i + 1}</div>
                                <div class="validator-info">
                                    <div class="validator-name">${v.moniker || 'Validator ' + (i + 1)}</div>
                                    <div class="validator-address">${shortenHash(v.operator_address || v.address, 10)}</div>
                                </div>
                            </div>
                        </td>
                        <td>${formatSltn(v.tokens || v.stake)} SLTN</td>
                        <td>${((v.commission_rate || v.commission || 0) * 100).toFixed(1)}%</td>
                        <td><span class="badge ${v.jailed ? 'badge-warning' : 'badge-success'}">${v.jailed ? 'Jailed' : 'Active'}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load validators:', e);
                document.getElementById('validatorsTable').innerHTML = 
                    '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Failed to load validators</td></tr>';
            }
        }
        
        async function loadStakingStats() {
            try {
                const data = await fetchRpc('/staking/statistics');
                document.getElementById('totalStaked').textContent = formatSltn(data.total_bonded || data.total_staked) + ' SLTN';
                
                const apy = data.current_apy || data.apy || 13.33;
                document.getElementById('stakingApy').textContent = apy.toFixed(2) + '%';
            } catch (e) {
                console.error('Failed to load staking stats:', e);
            }
        }
        
        async function loadSupply() {
            try {
                const data = await fetchRpc('/supply/total');
                const supply = data.total_supply || data.supply || data;
                document.getElementById('totalSupply').textContent = formatSltn(supply) + ' SLTN';
            } catch (e) {
                console.error('Failed to load supply:', e);
            }
        }
        
        async function loadRecentBlocks() {
            try {
                const status = await fetchRpc('/status');
                const currentHeight = status.height || status.block_height || 0;
                
                if (currentHeight === 0) {
                    document.getElementById('blocksTable').innerHTML = 
                        '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No blocks yet</td></tr>';
                    return;
                }
                
                // Fetch last 5 blocks
                const blocks = [];
                for (let h = currentHeight; h > Math.max(0, currentHeight - 5); h--) {
                    try {
                        const block = await fetchRpc(`/block/${h}`);
                        blocks.push(block);
                    } catch (e) {
                        // Block might not exist yet
                    }
                }
                
                const tbody = document.getElementById('blocksTable');
                if (blocks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No blocks found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = blocks.map(b => `
                    <tr>
                        <td><a href="#" class="hash-link" onclick="searchBlock(${b.height})">${formatNumber(b.height)}</a></td>
                        <td class="address">${shortenHash(b.hash, 10)}</td>
                        <td>${b.tx_count || b.transactions?.length || 0}</td>
                        <td>${b.timestamp ? new Date(b.timestamp).toLocaleTimeString() : '--'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load blocks:', e);
                document.getElementById('blocksTable').innerHTML = 
                    '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Failed to load blocks</td></tr>';
            }
        }
        
        // Search
        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            // Detect search type
            if (query.startsWith('sultan1')) {
                // Address search
                try {
                    const balance = await fetchRpc(`/balance/${query}`);
                    alert(`Balance for ${shortenHash(query, 12)}:\n${formatSltn(balance.balance || balance)} SLTN`);
                } catch (e) {
                    showError('Address not found');
                }
            } else if (/^\d+$/.test(query)) {
                // Block height
                searchBlock(parseInt(query));
            } else {
                // Transaction hash
                try {
                    const tx = await fetchRpc(`/tx/${query}`);
                    alert(`Transaction found!\nFrom: ${shortenHash(tx.from, 10)}\nTo: ${shortenHash(tx.to, 10)}\nAmount: ${formatSltn(tx.amount)} SLTN`);
                } catch (e) {
                    showError('Transaction not found');
                }
            }
        }
        
        async function searchBlock(height) {
            try {
                const block = await fetchRpc(`/block/${height}`);
                alert(`Block #${height}\nHash: ${shortenHash(block.hash, 16)}\nTransactions: ${block.tx_count || 0}\nTime: ${block.timestamp ? new Date(block.timestamp).toLocaleString() : 'Unknown'}`);
            } catch (e) {
                showError('Block not found');
            }
        }
        
        // Enter key handler
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleSearch();
        });
        
        // Initial load
        async function init() {
            const connected = await tryEndpoints();
            if (!connected) {
                showError('Could not connect to Sultan RPC. Make sure a node is running.');
            }
            
            // Load all data
            await Promise.all([
                loadStatus(),
                loadValidators(),
                loadStakingStats(),
                loadSupply(),
                loadRecentBlocks()
            ]);
        }
        
        // Auto-refresh every 6 seconds (block time is ~2s, but we don't need to be that aggressive)
        init();
        setInterval(async () => {
            await loadStatus();
            await loadRecentBlocks();
        }, 6000);
        
        // Refresh validators/staking less frequently
        setInterval(async () => {
            await loadValidators();
            await loadStakingStats();
        }, 30000);
    </script>
</body>
</html>
